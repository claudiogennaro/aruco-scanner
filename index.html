<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ArUco 4x4 Scanner</title>
    <style>
        body { margin: 0; padding: 0; background-color: #000; color: white; font-family: sans-serif; overflow: hidden; }
        
        #container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        
        /* Video is hidden, we draw to canvas */
        #videoInput { display: none; }
        #canvasOutput { width: 100%; height: 100%; object-fit: contain; }
        
        /* Loading Overlay */
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(30, 30, 30, 0.9); padding: 25px; border-radius: 12px;
            text-align: center; z-index: 20; border: 1px solid #555; width: 280px;
        }
        #status { margin-top: 15px; font-size: 0.9rem; color: #ddd; }
        
        /* Info Panel at bottom */
        #infoPanel {
            position: absolute; bottom: 20px; left: 20px; right: 20px;
            background: rgba(0, 0, 0, 0.6); padding: 15px; border-radius: 12px;
            pointer-events: none; backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        h3 { margin: 0 0 8px 0; font-size: 1.1em; color: #00ffcc; }
        p { margin: 4px 0; font-size: 0.9em; display: flex; justify-content: space-between; }
        .val { font-weight: bold; color: #ffeb3b; font-family: monospace; font-size: 1.1em; }

        /* Spinner Animation */
        .spinner {
            border: 4px solid #333; border-top: 4px solid #00ffcc; border-radius: 50%;
            width: 35px; height: 35px; animation: spin 1s linear infinite; margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="container">
    <div id="loading">
        <div class="spinner"></div>
        <div id="status">Downloading OpenCV...<br>(This may take a moment)</div>
    </div>
    
    <video id="videoInput" playsinline webkit-playsinline></video>
    <canvas id="canvasOutput"></canvas>

    <div id="infoPanel">
        <h3>ArUco Scanner</h3>
        <p>System: <span id="fps" class="val">-</span></p>
        <p>Markers: <span id="count" class="val">0</span></p>
        <p>IDs: <span id="ids" class="val">--</span></p>
    </div>
</div>

<!-- Load OpenCV with ArUco support -->
<script async src="https://cdn.jsdelivr.net/npm/@jgoenetxea/opencv-contrib-js/opencv.js" onload="onScriptLoad()"></script>

<script type="text/javascript">
    const statusMsg = document.getElementById('status');
    const loadingDiv = document.getElementById('loading');
    const video = document.getElementById('videoInput');
    const canvas = document.getElementById('canvasOutput');
    const fpsSpan = document.getElementById('fps');
    const countSpan = document.getElementById('count');
    const idsSpan = document.getElementById('ids');

    let stream = null;
    let streaming = false;
    
    // OpenCV objects
    let cap, src, dst, gray, dictionary, parameter, corners, ids;

    function onScriptLoad() {
        statusMsg.innerText = "Compiling WASM...";
        // We poll every 500ms to see if 'cv' is ready
        const checkCv = setInterval(() => {
            if (typeof cv !== 'undefined' && cv.getBuildInformation) {
                // Try calling a function to ensure it's fully initialized
                try {
                    console.log(cv.getBuildInformation());
                    clearInterval(checkCv);
                    onOpenCvReady();
                } catch (e) {
                    console.log("Waiting for OpenCV initialization...");
                }
            }
        }, 500);
    }

    function onOpenCvReady() {
        statusMsg.innerText = "Starting Camera...";
        startCamera();
    }

    async function startCamera() {
        try {
            const constraints = {
                audio: false,
                video: {
                    facingMode: 'environment', // Rear camera
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            video.play();
            
            video.onloadedmetadata = function() {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                initArUco();
            };
        } catch (err) {
            statusMsg.innerText = "Camera Error: " + err.message;
            statusMsg.style.color = "red";
        }
    }

    function initArUco() {
        statusMsg.innerText = "Initializing Detector...";
        
        // Setup Matrices
        src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
        dst = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
        gray = new cv.Mat();
        
        cap = new cv.VideoCapture(video);
        corners = new cv.MatVector();
        ids = new cv.Mat();
        
        // Load Dictionary
        // Try multiple methods to support different OpenCV versions
        try {
            if (cv.aruco && cv.aruco.getPredefinedDictionary) {
                dictionary = cv.aruco.getPredefinedDictionary(cv.aruco.DICT_4X4_1000);
            } else if (cv.aruco && cv.aruco.Dictionary) {
                dictionary = new cv.aruco.Dictionary(cv.aruco.DICT_4X4_1000);
            } else {
                throw new Error("ArUco module not found in cv object");
            }
            
            parameter = new cv.aruco.DetectorParameters();
            // Tune for performance/accuracy
            parameter.adaptiveThreshWinSizeMin = 3;
            parameter.adaptiveThreshWinSizeMax = 23;
            parameter.adaptiveThreshWinSizeStep = 10;
            parameter.minMarkerPerimeterRate = 0.05; // Ignore tiny markers

            // Start Loop
            loadingDiv.style.display = "none";
            streaming = true;
            requestAnimationFrame(processVideo);

        } catch (e) {
            statusMsg.innerText = "Error: " + e.message;
            console.error(e);
        }
    }

    const FPS = 30;
    let lastTime = 0;

    function processVideo(now) {
        if (!streaming) return;

        // Throttle FPS
        if (now - lastTime < 1000 / FPS) {
            requestAnimationFrame(processVideo);
            return;
        }
        lastTime = now;

        try {
            cap.read(src);
            
            // Grayscale for detection
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

            // Detect
            cv.aruco.detectMarkers(gray, dictionary, corners, ids, parameter);

            // Draw on source
            src.copyTo(dst);
            
            if (ids.rows > 0) {
                cv.aruco.drawDetectedMarkers(dst, corners, ids);
                updateInfo(ids);
            } else {
                updateInfo(null);
            }

            cv.imshow('canvasOutput', dst);
            fpsSpan.innerText = "ACTIVE";

        } catch (err) {
            console.error(err);
            fpsSpan.innerText = "ERR";
        }

        requestAnimationFrame(processVideo);
    }

    function updateInfo(foundIds) {
        if (!foundIds || foundIds.rows === 0) {
            countSpan.innerText = "0";
            idsSpan.innerText = "--";
            return;
        }

        let count = foundIds.rows;
        let idList = [];
        for (let i = 0; i < count; ++i) {
            idList.push(foundIds.data32S[i]);
        }
        countSpan.innerText = count;
        idsSpan.innerText = idList.join(", ");
    }

    // Cleanup
    window.addEventListener('beforeunload', () => {
        if(src) src.delete(); if(dst) dst.delete(); if(gray) gray.delete();
        if(corners) corners.delete(); if(ids) ids.delete();
        if(dictionary) dictionary.delete(); if(parameter) parameter.delete();
    });
</script>
</body>
</html>
