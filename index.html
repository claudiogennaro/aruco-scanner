<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ArUco 4x4 Scanner</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #222;
            color: white;
            font-family: sans-serif;
            overflow: hidden;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }

        #videoInput {
            display: none; 
        }

        #canvasOutput {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 10;
        }

        #infoPanel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 8px;
            pointer-events: none;
        }

        h3 { margin: 0 0 10px 0; font-size: 1.1em; color: #00ffcc; }
        p { margin: 5px 0; font-size: 0.9em; }
        .highlight { color: #ffeb3b; font-weight: bold; }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="container">
    <div id="loading">
        <div class="spinner"></div>
        <div id="status">Downloading OpenCV (8MB)...<br>Please wait.</div>
    </div>
    
    <video id="videoInput" playsinline webkit-playsinline></video>
    <canvas id="canvasOutput"></canvas>

    <div id="infoPanel">
        <h3>ArUco 4x4 Data</h3>
        <p>Status: <span id="fps" class="highlight">-</span></p>
        <p>Detected: <span id="count" class="highlight">0</span></p>
        <p>IDs: <span id="ids" class="highlight">None</span></p>
    </div>
</div>

<!-- 
    FIX: Using a build hosted by the University of Washington (Makeability Lab) 
    that is known to include the ArUco 'contrib' modules. 
-->
<script async src="https://makeabilitylab.github.io/physcomp/common/opencv_js/opencv_js_4.5.4/opencv.js" onload="onOpenCvReady()" type="text/javascript"></script>

<script type="text/javascript">
    let video = document.getElementById('videoInput');
    let canvas = document.getElementById('canvasOutput');
    let statusMsg = document.getElementById('status');
    let loadingDiv = document.getElementById('loading');
    
    let fpsSpan = document.getElementById('fps');
    let countSpan = document.getElementById('count');
    let idsSpan = document.getElementById('ids');

    let stream = null;
    let streaming = false;
    
    let cap = null;
    let src = null;
    let dst = null;
    let gray = null;
    let dictionary = null;
    let parameter = null;
    let corners = null;
    let ids = null;
    let rvecs = null;
    let tvecs = null;

    function onOpenCvReady() {
        if (cv.getBuildInformation) {
            console.log(cv.getBuildInformation());
        }
        statusMsg.innerText = "OpenCV Loaded. Starting Camera...";
        startCamera();
    }

    async function startCamera() {
        try {
            const constraints = {
                audio: false,
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            video.play();
            
            video.onloadedmetadata = function() {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                initOpenCV();
            };
        } catch (err) {
            statusMsg.innerText = "Error: " + err.message;
            if(window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                alert("Camera requires HTTPS. Please use GitHub Pages.");
            }
        }
    }

    function initOpenCV() {
        statusMsg.innerText = "Initializing ArUco...";
        
        src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
        dst = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
        gray = new cv.Mat();
        
        cap = new cv.VideoCapture(video);
        
        corners = new cv.MatVector();
        ids = new cv.Mat();
        
        // --- ARUCO INITIALIZATION ---
        // We check where 'aruco' is located in this build
        if (!cv.aruco) {
            statusMsg.innerText = "Error: 'cv.aruco' module is missing in this build.";
            return;
        }

        // Use 4x4 Dictionary (1000 markers)
        // If this fails, we will fallback to standard DICT_4X4_50
        try {
            dictionary = new cv.aruco.Dictionary(cv.aruco.DICT_4X4_1000);
        } catch (e) {
            console.warn("Retrying with alternate dictionary init...");
            try {
                // Fallback for different OpenCV versions
                dictionary = cv.aruco.getPredefinedDictionary(cv.aruco.DICT_4X4_1000);
            } catch(e2) {
                statusMsg.innerText = "Error creating ArUco Dictionary.";
                return;
            }
        }

        parameter = new cv.aruco.DetectorParameters();
        
        // Tune parameters for better detection
        parameter.adaptiveThreshWinSizeMin = 3;
        parameter.adaptiveThreshWinSizeMax = 23;
        parameter.adaptiveThreshWinSizeStep = 10;
        parameter.minMarkerPerimeterRate = 0.03;

        streaming = true;
        loadingDiv.style.display = "none";
        requestAnimationFrame(processVideo);
    }

    const FPS = 30;
    let lastTime = 0;

    function processVideo(now) {
        if (!streaming) return;

        if (now - lastTime < 1000 / FPS) {
            requestAnimationFrame(processVideo);
            return;
        }
        lastTime = now;

        try {
            cap.read(src);
            src.copyTo(dst);
            
            // Convert to grayscale for detection (improves stability)
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

            // Detect
            cv.aruco.detectMarkers(gray, dictionary, corners, ids, parameter);

            if (ids.rows > 0) {
                // Draw detected markers
                cv.aruco.drawDetectedMarkers(dst, corners, ids);
                updateInfoPanel(ids);
            } else {
                updateInfoPanel(null);
            }

            cv.imshow('canvasOutput', dst);
            fpsSpan.innerText = "Running";

        } catch (err) {
            console.error(err);
            fpsSpan.innerText = "Error in Loop";
        }

        requestAnimationFrame(processVideo);
    }

    function updateInfoPanel(foundIds) {
        if (!foundIds || foundIds.rows === 0) {
            countSpan.innerText = "0";
            idsSpan.innerText = "None";
            return;
        }

        let count = foundIds.rows;
        let idList = [];
        
        for (let i = 0; i < count; ++i) {
            idList.push(foundIds.data32S[i]);
        }

        countSpan.innerText = count;
        idsSpan.innerText = idList.join(", ");
    }

    // Cleanup
    window.addEventListener('beforeunload', () => {
        if(src) src.delete();
        if(dst) dst.delete();
        if(gray) gray.delete();
        if(corners) corners.delete();
        if(ids) ids.delete();
        if(dictionary) dictionary.delete();
        if(parameter) parameter.delete();
    });
</script>
</body>
</html>